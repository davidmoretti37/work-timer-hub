# PTO Email Error Fix Summary

## Problem
The PTO email notification was failing with a **400 error** from Resend API, causing the system to fall back to opening Gmail compose window instead of sending emails automatically.

## Root Cause Analysis

### Error Message
```
Failed to load resource: the server responded with a status of 400 ()
❌ Email sending failed: FunctionsHttpError: Edge Function returned a non-2xx status code
```

### What Was Wrong
1. **Missing approval_token in query**: The frontend was inserting PTO data but not explicitly retrieving the `approval_token` field that's auto-generated by the database
2. **Undefined token in email**: The Edge Function was trying to use `ptoData.approval_token` in the email HTML, but it was `undefined`, creating malformed URLs like:
   ```
   http://localhost:8080/approve-pto?action=approve&token=undefined&plain=1
   ```
3. **Resend API rejection**: Resend's API rejected the email with a 400 error because the HTML contained invalid/malformed URLs
4. **Missing TypeScript definitions**: The `pto_requests` table wasn't defined in the Supabase types file, causing TypeScript errors

## Changes Made

### 1. Frontend Fix (src/pages/PTO.tsx)
**Before:**
```typescript
.select()
.single();
```

**After:**
```typescript
.select('*, approval_token')
.single();
```

Added explicit selection of the `approval_token` field and validation:
```typescript
if (!data) {
  throw new Error('Failed to create PTO request');
}

console.log('PTO request created with token:', data.approval_token);
```

Also fixed profile field references:
- Changed `data.display_name` → `data.full_name`
- Changed `data.email` → `user?.email`
- Changed `profile?.display_name` → `profile?.full_name`

### 2. Edge Function Fix (supabase/functions/send-pto-email/index.ts)
Added validation to catch missing tokens early:
```typescript
// Validate required fields
if (!ptoData) {
  throw new Error('ptoData is required')
}

if (!ptoData.approval_token) {
  throw new Error('approval_token is missing from ptoData')
}

console.log('Processing PTO request with token:', ptoData.approval_token)
```

### 3. TypeScript Definitions (src/integrations/supabase/types.ts)
Added complete `pto_requests` table definition with all fields:
- id, user_id, employee_name, confirmation_email
- request_type, start_date, end_date
- reason_type, custom_reason, employee_signature
- status, submission_date
- **approval_token, token_expires_at, token_used** ← Critical fields

## How It Works Now

1. **User submits PTO form** → Database creates record with auto-generated `approval_token` (UUID)
2. **Frontend retrieves complete data** → Including the `approval_token` field
3. **Edge Function validates token** → Ensures it exists before building email
4. **Email sent with valid URLs** → 
   - Approve: `http://localhost:8080/approve-pto?action=approve&token={VALID_UUID}&plain=1`
   - Reject: `http://localhost:8080/approve-pto?action=reject&token={VALID_UUID}&plain=1`
5. **Resend API accepts email** → Returns 200 success instead of 400 error

## Testing
To verify the fix works:
1. Submit a new PTO request through the form
2. Check browser console - you should see:
   ```
   PTO request created with token: <uuid>
   Processing PTO request with token: <uuid>
   ✅ Email sent successfully to fbayma@baycoaviation.com
   ```
3. Email should be delivered automatically without opening Gmail fallback

## Technical Details
- The `approval_token` is a UUID generated by PostgreSQL's `gen_random_uuid()` function
- Token expires after 14 days (`token_expires_at`)
- One-time use tracked by `token_used` boolean flag
- Unique index ensures fast lookup by token
